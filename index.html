<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendario Caudiel</title>
    <link rel="icon" href="caudielLogo.png" />
    <!-- Vincular el manifest -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#0044cc" />

    <!-- Icono para iOS (Safari necesita esto) -->
    <link rel="apple-touch-icon" href="logoCaudiel.png" />
    <style>
      body {
        font-family: "Arial", sans-serif;
        background: #fce4ec;
        padding: 20px;
        margin: 0;
        color: #5d5d5d;
      }

      header {
        position: relative;
        text-align: center;
        margin-bottom: 20px;
      }

      header .login-btn {
        position: absolute;
        top: 0;
        right: 0;
      }

      .logo-img {
        position: absolute;
        top: 10px;
        left: 10px;
        height: 80px;
        width: auto;
        pointer-events: none;
        user-select: none;
      }

      .dia-semana {
        text-align: center;
        font-weight: bold;
        padding: 10px 0;
        border-bottom: 1px solid #f8bbd0;
        background-color: #ffe3ee;
      }

      h1 {
        color: #d81b60;
        font-size: 2.5em;
        margin-bottom: 20px;
      }

      .login-btn {
        padding: 10px 20px;
        background-color: #d81b60;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1em;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .login-btn:hover {
        background-color: #f50057;
      }

      .login-form {
        position: absolute;
        top: 70px;
        right: 20px;
        background: #ffffff;
        border: 2px solid #f8bbd0;
        border-radius: 10px;
        padding: 15px;
        display: none;
        z-index: 100;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }

      .login-form.show {
        opacity: 1;
        pointer-events: auto;
      }

      .login-form input,
      .login-form button {
        display: block;
        margin-bottom: 10px;
        padding: 10px;
        width: 80%;
        font-size: 1em;
        border-radius: 5px;
      }

      .login-form button {
        background-color: #d81b60;
        color: white;
        border: none;
      }

      .login-form button:hover {
        background-color: #f50057;
      }

      .navegacion {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .navegacion button {
        padding: 12px 24px;
        font-size: 1.2em;
        cursor: pointer;
        background-color: #ff80ab;
        color: white;
        border: none;
        border-radius: 12px;
        transition: background-color 0.3s;
      }

      .navegacion button:hover {
        background-color: #f50057;
      }

      .calendario-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        margin-top: 20px;
      }

      .calendario {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        width: 90%;
        max-width: 1200px;
        background-color: #fff5f8;
        border: 2px solid #f8bbd0;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        box-sizing: border-box;
      }

      .calendario h2 {
        grid-column: span 7;
        text-align: center;
        font-size: 1.8em;
        color: #d81b60;
      }

      .calendario .dia {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        padding: 15px;
        height: 180px; /* ðŸ”¥ altura fija para todos los dÃ­as */
        border: 2px solid #f8bbd0;
        border-radius: 8px;
        background-color: #fff;
        cursor: pointer;
        overflow: hidden; /* evita que crezca mÃ¡s de la altura fija */
      }

      .dia {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 15px;
        min-height: 100px;
        border: 2px solid #f8bbd0;
        border-radius: 8px;
        background-color: #fff;
        cursor: pointer;
      }

      .numero {
        font-weight: bold;
        font-size: 1.5em;
        color: #d81b60;
        margin-bottom: 5px;
      }

      .nota {
        font-size: 1em;
        color: #555;
        text-align: center;
        max-height: 60px; /* ðŸ”¥ altura mÃ¡xima fija */
        overflow-y: auto; /* ðŸ”¥ scroll vertical si hay mucho texto */
        font-style: italic;
        width: 100%; /* se asegura de ocupar el ancho del dÃ­a */
        box-sizing: border-box;
        padding: 2px;
      }

      #modalTexto {
        max-height: 120px; /* ðŸ”¥ lÃ­mite de altura */
        overflow-y: auto; /* ðŸ”¥ scroll si el texto es muy largo */
        margin-bottom: 10px; /* separa del bloque de imÃ¡genes */
      }

      /* Pop-up (modal) */
      .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        padding-top: 60px;
      }

      .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 60%;
        max-width: 400px;
        border-radius: 10px;
      }

      .modal-content img {
        max-height: 150px; /* Alto mÃ¡ximo deseado */
        width: auto; /* El ancho se ajusta proporcionalmente */
        margin-top: 10px;
        border-radius: 8px;
        display: block;
        margin-left: auto;
        margin-right: auto;
        cursor: pointer; /* Para indicar que se puede hacer clic */
      }

      .close {
        width: 40px; /* tamaÃ±o fijo */
        height: 40px; /* mismo que width */
        line-height: 40px; /* para centrar la X verticalmente */
        text-align: center; /* centrar la X horizontalmente */
        font-size: 30px;
        background-color: #ff80ab;
        color: white;
        float: right;
        font-weight: bold;
        border: none;
        border-radius: 50%; /* cÃ­rculo perfecto */
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .close:hover,
      .close:focus {
        background-color: #f50057;
        text-decoration: none;
        cursor: pointer;
      }

      .navegacion select {
        padding: 10px;
        font-size: 1em;
        border-radius: 10px;
        border: 2px solid #f8bbd0;
        margin: 0 5px;
        background-color: white;
      }
      .switch-wrapper {
        width: 100px;
        height: 40px;
        background-color: #fff;
        border-radius: 10px;
        margin: 15px auto 0;
        position: relative;
        cursor: pointer;
        border: 2px solid #ccc;
      }

      #switch-indicador {
        width: 28px;
        height: 28px;
        background-color: #d81b60;
        border-radius: 6px;
        position: absolute;
        top: 6px;
        left: 6px;
        transition: all 0.3s ease;
      }

      #imagePreviewModal {
        display: none; /* Oculto por defecto */
        position: fixed;
        z-index: 99999999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);

        /* Flex para centrar contenido */
        display: flex;
        justify-content: center;
        align-items: center;

        /* Quitar padding que rompe el centrado vertical */
        padding: 0;
        box-sizing: border-box;
      }

      #imagePreviewModal .modal-image {
        max-width: 90vw;
        max-height: 90vh;
        width: auto;
        height: auto;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        object-fit: contain;
        display: block;
        margin: 0; /* centrado por flex */
      }

      #imagePreviewModal .close {
        position: fixed;
        top: 20px;
        right: 30px;
        width: 50px; /* Ancho fijo */
        height: 50px; /* Alto fijo igual al ancho */
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        font-size: 40px;
        font-weight: bold;
        border: none;
        border-radius: 50%; /* Hace que sea circular */
        display: flex; /* Centrar el contenido */
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 1001;
        transition: background-color 0.3s;
      }

      #imagePreviewModal .reset-btn {
        position: fixed;
        top: 20px;
        left: 30px;
        width: 50px;
        height: 50px;
        background-color: #d81b60;
        background-image: url("reset.png");
        background-size: 60%; /* Ajusta tamaÃ±o */
        background-repeat: no-repeat;
        background-position: center;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        z-index: 1001;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s;
      }
      #imagePreviewModal .reset-btn:hover {
        background-color: #f50057;
        text-decoration: none;
        cursor: pointer;
      }

      .imagenes-container {
        display: flex;
        overflow-x: auto;
        gap: 8px;
        max-width: 100%;
        max-height: 80px; /* ðŸ”¥ controla altura mÃ¡xima dentro del dÃ­a */
        padding: 5px 0;
        scroll-snap-type: x mandatory;
      }

      .imagenes-container img {
        height: 80px; /* ðŸ”¥ fija altura de cada imagen */
        width: auto;
        border-radius: 6px;
        flex-shrink: 0;
        scroll-snap-align: start;
      }

      @media (max-width: 600px) {
        .login-btn {
          display: none;
        }
        #imagePreviewModal .close {
          width: 40px;
          height: 40px;
          font-size: 30px;
        }
        #imagePreviewModal .reset-btn {
          display: none;
        }
        .calendario {
          grid-template-columns: 1fr;
        }
        .calendario .dia {
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          gap: 5px;
          border: 1px solid #f8bbd0;
          padding: 10px;
          margin-bottom: 10px;
        }
        .nota {
          text-align: left;
          flex-grow: 1;
        }
        .calendario h2 {
          font-size: 1.5em;
          grid-column: span 1;
        }
        .dia img {
          max-width: 100%;
          margin-top: 8px;
          border-radius: 8px;
        }
        .logo-img {
          position: fixed;
          top: 5px;
          left: 5px;
          height: 70px;
          width: auto;
          pointer-events: none;
          user-select: none;
        }
        .login-btn {
          position: fixed !important;
          top: 10px !important;
          right: 10px !important;
          font-size: 1em !important;
          padding: 10px 20px !important;
          z-index: 9999 !important;
        }
        .login-form {
          position: fixed !important;
          top: 60px !important;
          right: 10px !important;
          z-index: 9998 !important;
        }
        .resumen-semanal {
          display: flex;
          justify-content: space-between;
          background-color: #ffebf0;
          padding: 10px;
          margin-bottom: 10px;
          border: 2px solid #f8bbd0;
          border-radius: 10px;
          font-weight: bold;
          font-size: 0.9em;
          color: #d81b60;
        }
        .resumen-dia {
          flex: 1;
          text-align: center;
          cursor: pointer;
        }
        .resumen-dia .alerta {
          display: inline-block;
          margin-left: 5px;
          font-size: 2em;
          font-weight: bold;
          color: #ff0033;
          animation: parpadeo 1s infinite, rebote 1.5s infinite;
          text-shadow: 1px 1px 2px #fff, 0 0 5px #ff0033;
        }
        @keyframes parpadeo {
          0%,
          100% {
            opacity: 1;
          }
          50% {
            opacity: 0;
          }
        }
        @keyframes rebote {
          0%,
          100% {
            transform: translateY(0);
          }
          50% {
            transform: translateY(-3px);
          }
        }
      }
    </style>
  </head>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Asegurarse de que el previsualizador estÃ© cerrado al cargar
      const imageModal = document.getElementById("imagePreviewModal");
      const imageModalImg = imageModal.querySelector(".modal-image");
      imageModal.style.display = "none";
      imageModalImg.src = "";
    });

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("service-worker.js")
        .then(() => console.log("Service Worker registrado"))
        .catch((err) => console.error("Error en Service Worker:", err));
    }
  </script>
  <body>
    <header>
      <img src="caudiel.png" alt="Caudiel Logo" class="logo-img" />
      <h1>Calendario Caudiel 2025-2026</h1>
      <button class="login-btn" onclick="toggleLoginForm()">Log In</button>
      <div class="switch-wrapper" onclick="siguientePaleta()">
        <div id="switch-indicador"></div>
      </div>
    </header>

    <div class="login-form" id="loginForm">
      <input type="text" id="username" placeholder="Usuario" />
      <input type="password" id="password" placeholder="ContraseÃ±a" />
      <button onclick="login()">Entrar</button>
    </div>

    <div class="navegacion">
      <button id="btn-anterior">Anterior</button>
      <button id="btn-siguiente">Siguiente</button>
      <select id="select-mes">
        <option value="0">Enero</option>
        <option value="1">Febrero</option>
        <option value="2">Marzo</option>
        <option value="3">Abril</option>
        <option value="4">Mayo</option>
        <option value="5">Junio</option>
        <option value="6">Julio</option>
        <option value="7">Agosto</option>
        <option value="8">Septiembre</option>
        <option value="9">Octubre</option>
        <option value="10">Noviembre</option>
        <option value="11">Diciembre</option>
      </select>

      <select id="select-anio">
        <!-- Opciones serÃ¡n llenadas dinÃ¡micamente por JS -->
      </select>

      <select id="select-semana" style="display: none">
        <!-- Opciones de semana solo para mÃ³viles -->
      </select>
    </div>

    <div class="calendario-container" id="calendarios"></div>

    <!-- Modal (Pop-up) -->
    <div id="myModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modalFecha"></h2>
        <p id="modalTexto"></p>
        <div id="modalImagen"></div>
      </div>
    </div>

    <!-- Previsualizador de imagen -->
    <div id="imagePreviewModal" class="modal">
      <button class="reset-btn" title="Restaurar imagen"></button>
      <span class="close">&times;</span>
      <img class="modal-image" src="" alt="PrevisualizaciÃ³n" />
    </div>

    <script type="module">
      document.addEventListener("DOMContentLoaded", function () {
        document.querySelector(".close").addEventListener("click", function () {
          document.getElementById("myModal").style.display = "none";
        });
      });

      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getFirestore,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSy...827",
        authDomain: "calendariocaudiel.firebaseapp.com",
        projectId: "calendariocaudiel",
        storageBucket: "calendariocaudiel.appspot.com",
        messagingSenderId: "780740498474",
        appId: "1:780740498474:web:d741fd88bc94f926685f53",
        measurementId: "G-PH31VFY827",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const calendarios = document.getElementById("calendarios");
      let today = new Date();
      let currentYear = today.getFullYear();
      let currentMonth = today.getMonth();
      let currentWeekStartDate = getStartOfWeek(new Date());

      const selectMes = document.getElementById("select-mes");
      const selectAnio = document.getElementById("select-anio");
      const selectSemana = document.getElementById("select-semana");

      for (let y = 2024; y <= 2026; y++) {
        const option = document.createElement("option");
        option.value = y;
        option.textContent = y;
        selectAnio.appendChild(option);
      }

      selectMes.value = currentMonth;
      selectAnio.value = currentYear;

      function manejarCambioMesOAnio() {
        currentYear = parseInt(selectAnio.value);
        currentMonth = parseInt(selectMes.value);

        // âš ï¸ OJO: actualizar semanas ANTES de usar selectSemana.value
        actualizarSemanas(currentYear, currentMonth, true);

        if (esMovil()) {
          // Usa la semana seleccionada (ya se actualizÃ³ el combo correctamente arriba)
          currentWeekStartDate = new Date(selectSemana.value);
        }

        crearCalendario(currentYear, currentMonth);
      }

      selectMes.addEventListener("change", manejarCambioMesOAnio);
      selectAnio.addEventListener("change", manejarCambioMesOAnio);

      const diasSemana = ["Lun", "Mar", "MiÃ©", "Jue", "Vie", "SÃ¡b", "Dom"];
      const meses = [
        "Enero",
        "Febrero",
        "Marzo",
        "Abril",
        "Mayo",
        "Junio",
        "Julio",
        "Agosto",
        "Septiembre",
        "Octubre",
        "Noviembre",
        "Diciembre",
      ];

      function esMovil() {
        return window.innerWidth <= 600;
      }

      function actualizarSemanas(year, month, seleccionarSemanaActual = true) {
        selectSemana.innerHTML = "";

        const primerDiaMes = new Date(year, month, 1);
        const ultimoDiaMes = new Date(year, month + 1, 0);

        let fechaInicioSemana = getStartOfWeek(primerDiaMes);
        let semana = 1;
        let indexSemanaActual = 0;

        while (fechaInicioSemana <= ultimoDiaMes) {
          const opcion = document.createElement("option");
          opcion.value = fechaInicioSemana.toISOString();

          const dia = fechaInicioSemana.getDate();
          const mes = fechaInicioSemana.getMonth();

          opcion.textContent = `Semana ${semana} (${dia} ${meses[mes]})`;
          selectSemana.appendChild(opcion);

          // Comprobar si es la semana actual
          if (
            Math.abs(currentWeekStartDate - fechaInicioSemana) <
            4 * 24 * 60 * 60 * 1000
          ) {
            indexSemanaActual = semana - 1;
          }

          fechaInicioSemana.setDate(fechaInicioSemana.getDate() + 7);
          semana++;
        }

        // Selecciona la semana actual
        if (seleccionarSemanaActual && selectSemana.options.length > 0) {
          selectSemana.selectedIndex = indexSemanaActual;
          currentWeekStartDate = new Date(selectSemana.value);
        }
      }

      if (window.innerWidth <= 600) {
        selectSemana.style.display = "inline-block";

        actualizarSemanas(currentYear, currentMonth);

        selectSemana.addEventListener("change", () => {
          const fechaSeleccionada = new Date(selectSemana.value);
          if (!isNaN(fechaSeleccionada)) {
            currentWeekStartDate = fechaSeleccionada;
            currentYear = fechaSeleccionada.getFullYear();
            currentMonth = fechaSeleccionada.getMonth();
            crearCalendario(currentYear, currentMonth);
          }
        });

        selectAnio.addEventListener("change", () => {
          currentYear = parseInt(selectAnio.value);
          actualizarSemanas(currentYear, currentMonth, true);
          crearCalendario(currentYear, currentMonth);
        });
      }

      function getStartOfWeek(date) {
        const day = date.getDay() || 7;
        const diff = date.getDate() - day + 1;
        return new Date(date.setDate(diff));
      }

      async function crearCalendario(year, month) {
        calendarios.innerHTML = "";
        const calendario = document.createElement("div");
        calendario.className = "calendario";
        const titulo = document.createElement("h2");

        if (esMovil()) {
          const semanaMes = currentWeekStartDate.getMonth();
          const semanaAÃ±o = currentWeekStartDate.getFullYear();
          titulo.textContent = `${meses[semanaMes]} ${semanaAÃ±o}`;
          calendario.appendChild(titulo);

          const resumen = document.createElement("div");
          resumen.className = "resumen-semanal";

          const resumenHandlers = [];

          for (let i = 0; i < 7; i++) {
            const label = document.createElement("div");
            label.className = "resumen-dia";
            label.textContent = diasSemana[i];
            resumen.appendChild(label);
            resumenHandlers.push(label);
          }
          calendario.appendChild(resumen);

          for (let i = 0; i < 7; i++) {
            const fecha = new Date(currentWeekStartDate);
            fecha.setDate(currentWeekStartDate.getDate() + i);
            const y = fecha.getFullYear();
            const m = fecha.getMonth();
            const d = fecha.getDate();

            const celda = document.createElement("div");
            celda.className = "dia";
            const numero = document.createElement("div");
            numero.className = "numero";
            numero.textContent = d;
            const nota = document.createElement("div");
            nota.className = "nota";
            nota.textContent = "Cargando...";

            celda.append(numero, nota);
            calendario.appendChild(celda);

            celda.addEventListener("click", () => {
              mostrarModal(d, m, y);
            });

            try {
              const docRef = doc(db, `notas${y}${m + 1}`, String(d));
              const docSnap = await getDoc(docRef);
              if (docSnap.exists()) {
                const data = docSnap.data();
                nota.textContent = data.nota || "";
                if (data.imagenesBase64 && Array.isArray(data.imagenesBase64)) {
                  const contenedor = document.createElement("div");
                  contenedor.className = "imagenes-container";

                  data.imagenesBase64.forEach((src) => {
                    const img = document.createElement("img");
                    img.src = src;
                    img.alt = "Imagen del dÃ­a";
                    contenedor.appendChild(img);
                  });

                  celda.appendChild(contenedor);
                } else if (data.imagenBase64) {
                  const contenedor = document.createElement("div");
                  contenedor.className = "imagenes-container";

                  const img = document.createElement("img");
                  img.src = data.imagenBase64;
                  img.alt = "Imagen del dÃ­a";
                  contenedor.appendChild(img);

                  celda.appendChild(contenedor);
                }

                if (
                  (data.nota && data.nota.trim() !== "") ||
                  data.imagenBase64
                ) {
                  const alerta = document.createElement("span");
                  alerta.textContent = "!";
                  alerta.className = "alerta";
                  resumenHandlers[i].appendChild(alerta);
                  resumenHandlers[i].addEventListener("click", () => {
                    mostrarModal(d, m, y);
                  });
                }
              } else {
                nota.textContent = "";
              }
            } catch (e) {
              nota.textContent = "[Error]";
              console.error(e);
            }
          }
        } else {
          titulo.textContent = `${meses[month]} ${year}`;
          calendario.appendChild(titulo);
          diasSemana.forEach((dia) => {
            const sd = document.createElement("div");
            sd.className = "dia-semana";
            sd.textContent = dia;
            calendario.appendChild(sd);
          });

          const primerDia = new Date(year, month, 1).getDay() || 7;
          for (let i = 1; i < primerDia; i++)
            calendario.appendChild(document.createElement("div"));

          const diasEnMes = new Date(year, month + 1, 0).getDate();
          for (let d = 1; d <= diasEnMes; d++) {
            const celda = document.createElement("div");
            celda.className = "dia";
            const numero = document.createElement("div");
            numero.className = "numero";
            numero.textContent = d;
            const nota = document.createElement("div");
            nota.className = "nota";
            nota.textContent = "Cargando...";

            celda.append(numero, nota);
            calendario.appendChild(celda);

            celda.addEventListener("click", () => {
              mostrarModal(d, month, year);
            });

            try {
              const docRef = doc(db, `notas${year}${month + 1}`, String(d));
              const docSnap = await getDoc(docRef);
              if (docSnap.exists()) {
                const data = docSnap.data();
                nota.textContent = data.nota || "";
                if (data.imagenesBase64 && Array.isArray(data.imagenesBase64)) {
                  const contenedor = document.createElement("div");
                  contenedor.className = "imagenes-container";

                  data.imagenesBase64.forEach((src) => {
                    const img = document.createElement("img");
                    img.src = src;
                    img.alt = "Imagen del dÃ­a";
                    contenedor.appendChild(img);
                  });

                  celda.appendChild(contenedor);
                } else if (data.imagenBase64) {
                  const contenedor = document.createElement("div");
                  contenedor.className = "imagenes-container";

                  const img = document.createElement("img");
                  img.src = data.imagenBase64;
                  img.alt = "Imagen del dÃ­a";
                  contenedor.appendChild(img);

                  celda.appendChild(contenedor);
                }
              } else nota.textContent = "";
            } catch (e) {
              nota.textContent = "[Error]";
              console.error(e);
            }
          }
        }

        calendarios.appendChild(calendario);
        cambiarPaleta(paletaActual);
      }

      function mostrarModal(dia, mes, aÃ±o) {
        const modal = document.getElementById("myModal");
        const modalFecha = document.getElementById("modalFecha");
        const modalTexto = document.getElementById("modalTexto");
        const modalImagen = document.getElementById("modalImagen");

        modal.style.display = "block";
        modalFecha.textContent = `${dia} ${meses[mes]} ${aÃ±o}`;

        // Limpiar contenido previo
        modalTexto.textContent = "Cargando...";
        modalImagen.innerHTML = "";

        try {
          const docRef = doc(db, `notas${aÃ±o}${mes + 1}`, String(dia));
          getDoc(docRef).then((docSnap) => {
            if (docSnap.exists()) {
              const data = docSnap.data();
              modalTexto.textContent = data.nota || "";
              if (data.imagenesBase64 && Array.isArray(data.imagenesBase64)) {
                const contenedor = document.createElement("div");
                contenedor.className = "imagenes-container";

                data.imagenesBase64.forEach((src) => {
                  const img = document.createElement("img");
                  img.src = src;
                  img.alt = "Imagen del dÃ­a";
                  contenedor.appendChild(img);
                });

                modalImagen.appendChild(contenedor); // âœ… ahora va al popup
              } else if (data.imagenBase64) {
                const contenedor = document.createElement("div");
                contenedor.className = "imagenes-container";

                const img = document.createElement("img");
                img.src = data.imagenBase64;
                img.alt = "Imagen del dÃ­a";
                contenedor.appendChild(img);

                modalImagen.appendChild(contenedor); // âœ… al popup
              }
            } else modalTexto.textContent = "";
          });
        } catch (e) {
          modalTexto.textContent = "[Error]";
          console.error(e);
        }
      }

      document.getElementById("btn-anterior").addEventListener("click", () => {
        if (esMovil()) {
          currentWeekStartDate.setDate(currentWeekStartDate.getDate() - 7);
          currentYear = currentWeekStartDate.getFullYear();
          currentMonth = currentWeekStartDate.getMonth();

          selectAnio.value = currentYear;
          selectMes.value = currentMonth;

          actualizarSemanas(currentYear, currentMonth);
          // Selecciona la semana correspondiente
          for (let i = 0; i < selectSemana.options.length; i++) {
            const fecha = new Date(selectSemana.options[i].value);
            const diff = Math.abs(fecha - currentWeekStartDate);
            if (diff < 4 * 24 * 60 * 60 * 1000) {
              selectSemana.selectedIndex = i;
              break;
            }
          }
        } else {
          if (currentMonth === 0) {
            currentMonth = 11;
            currentYear--;
          } else {
            currentMonth--;
          }
          selectAnio.value = currentYear;
          selectMes.value = currentMonth;
        }

        crearCalendario(currentYear, currentMonth);
      });

      document.getElementById("btn-siguiente").addEventListener("click", () => {
        if (esMovil()) {
          currentWeekStartDate.setDate(currentWeekStartDate.getDate() + 7);
          currentYear = currentWeekStartDate.getFullYear();
          currentMonth = currentWeekStartDate.getMonth();

          selectAnio.value = currentYear;
          selectMes.value = currentMonth;

          actualizarSemanas(currentYear, currentMonth);
          for (let i = 0; i < selectSemana.options.length; i++) {
            const fecha = new Date(selectSemana.options[i].value);
            const diff = Math.abs(fecha - currentWeekStartDate);
            if (diff < 4 * 24 * 60 * 60 * 1000) {
              selectSemana.selectedIndex = i;
              break;
            }
          }
        } else {
          if (currentMonth === 11) {
            currentMonth = 0;
            currentYear++;
          } else {
            currentMonth++;
          }
          selectAnio.value = currentYear;
          selectMes.value = currentMonth;
        }

        crearCalendario(currentYear, currentMonth);
      });

      crearCalendario(currentYear, currentMonth);
    </script>

    <script>
      function toggleLoginForm() {
        const form = document.getElementById("loginForm");
        form.classList.toggle("show");
      }

      function login() {
        const user = document.getElementById("username").value.trim();
        const pass = document.getElementById("password").value.trim();
        if (user === "CaudielAdmin" && pass === "CaudielAdmin") {
          sessionStorage.setItem("isLoggedIn", "true");
          window.location.href = "admin.html";
        } else {
          alert("Credenciales incorrectas");
        }
      }

      let paletaActual = 0;
      const paletas = [
        {
          fondo: "#fce4ec",
          texto: "#5d5d5d",
          primario: "#d81b60",
          primarioHover: "#f50057",
          secundario: "#ffe3ee",
          borde: "#f8bbd0",
          fondoSemanal: "#ffebf0",
        },
        {
          fondo: "#e8f5e9",
          texto: "#2e7d32",
          primario: "#388e3c",
          primarioHover: "#43a047",
          secundario: "#d0f0d0",
          borde: "#a5d6a7",
          fondoSemanal: "#e0f7e9",
        },
        {
          fondo: "#e6f2ff",
          texto: "#003366",
          primario: "#005bb5",
          primarioHover: "#007acc",
          secundario: "#cce6ff",
          borde: "#99ccff",
          fondoSemanal: "#d9ecff",
        },
      ];

      function siguientePaleta() {
        paletaActual = (paletaActual + 1) % paletas.length;
        cambiarPaleta(paletaActual);
      }

      function cambiarPaleta(index) {
        paletaActual = index;
        const p = paletas[index];

        // Estilos generales
        document.body.style.background = p.fondo;
        document.body.style.color = p.texto;

        document
          .querySelectorAll("h1, .numero, .resumen-semanal, .calendario h2")
          .forEach((el) => {
            el.style.color = p.primario;
          });

        document
          .querySelectorAll(
            ".login-btn, .navegacion button, .login-form button, .close"
          )
          .forEach((el) => {
            el.style.backgroundColor = p.primario;
            el.style.color = "white";
          });

        document
          .querySelectorAll(".calendario, .dia, .login-form, .resumen-semanal")
          .forEach((el) => {
            el.style.borderColor = p.borde;
          });

        document.querySelectorAll(".dia-semana").forEach((el) => {
          el.style.backgroundColor = p.secundario;
          el.style.borderBottomColor = p.borde;
        });

        document.querySelectorAll(".calendario").forEach((el) => {
          el.style.backgroundColor = p.secundario;
        });

        document.querySelectorAll("select").forEach((el) => {
          el.style.borderColor = p.borde;
          el.style.color = p.texto;
        });

        // Mover y recolorear el cuadrado del switch
        const indicador = document.getElementById("switch-indicador");
        const posiciones = ["6px", "calc(50% - 14px)", "calc(100% - 34px)"];
        indicador.style.left = posiciones[index];
        indicador.style.backgroundColor = p.primario;
        document.querySelector(".switch-wrapper").style.borderColor = p.borde;

        document.querySelectorAll(".resumen-semanal").forEach((el) => {
          el.style.backgroundColor = p.fondoSemanal;
        });

        // Cambiar color del signo "!" segÃºn paleta
        const colorAlertas = ["#ff0033", "#2e7d32", "#005bb5"];
        document.querySelectorAll(".alerta").forEach((el) => {
          el.style.color = colorAlertas[index];
          el.style.textShadow = `1px 1px 2px #fff, 0 0 5px ${colorAlertas[index]}`;
        });

        document
          .querySelectorAll(
            ".login-btn, .navegacion button, .login-form button, .close, .reset-btn"
          )
          .forEach((el) => {
            el.style.backgroundColor = p.primario;
            el.style.color = "white";

            // Hover dinÃ¡mico
            el.onmouseenter = () =>
              (el.style.backgroundColor = p.primarioHover);
            el.onmouseleave = () => (el.style.backgroundColor = p.primario);
          });
      }

      // Inicializar paleta al cargar
      window.addEventListener("DOMContentLoaded", () => cambiarPaleta(0));

      document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById("myModal");
        const closeBtn = document.querySelector(".close");

        // Cerrar al hacer clic en la X
        closeBtn.addEventListener("click", () => {
          modal.style.display = "none";
        });

        // Cerrar al hacer clic fuera del contenido
        modal.addEventListener("click", (event) => {
          if (event.target === modal) {
            modal.style.display = "none";
          }
        });
      });

      // Detecta clics fuera del login-form
      document.addEventListener("click", function (event) {
        const loginForm = document.getElementById("loginForm");
        const loginBtn = document.querySelector(".login-btn");

        // Si el login estÃ¡ abierto y el clic NO fue dentro del form ni en el botÃ³n
        if (
          loginForm.classList.contains("show") &&
          !loginForm.contains(event.target) &&
          event.target !== loginBtn
        ) {
          loginForm.classList.remove("show");
        }
      });

      // Ejecutar login al pulsar Enter si el login estÃ¡ abierto
      document.addEventListener("keydown", function (event) {
        const loginForm = document.getElementById("loginForm");
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();

        if (loginForm.classList.contains("show") && event.key === "Enter") {
          // Solo iniciar sesiÃ³n si hay algo en los inputs
          if (username !== "" || password !== "") {
            login();
          }
        }
      });

      // --- Previsualizador de imÃ¡genes ---
      const imageModal = document.getElementById("imagePreviewModal");
      const imageModalImg = imageModal.querySelector(".modal-image");
      const imageModalClose = imageModal.querySelector(".close");

      // --- BOTÃ“N DE RESET ---
      const resetBtn = imageModal.querySelector(".reset-btn");

      function resetImageModal() {
        scale = 1;
        imageModalImg.style.transform = `scale(${scale})`;
        imageModalImg.style.position = "relative";
        imageModalImg.style.left = "0px";
        imageModalImg.style.top = "0px";
      }

      resetBtn.addEventListener("click", () => {
        scale = 1;
        imageModalImg.style.transform = `scale(${scale})`;
        imageModalImg.style.position = "relative";
        imageModalImg.style.left = "0px";
        imageModalImg.style.top = "0px";
      });

      // --- Zoom y arrastre ---
      let scale = 1;
      let isDragging = false;
      let startX, startY;

      imageModalImg.addEventListener("wheel", (e) => {
        e.preventDefault();
        scale += e.deltaY * -0.001;
        scale = Math.min(Math.max(0.5, scale), 3);
        imageModalImg.style.transform = `scale(${scale})`;
      });

      imageModalImg.addEventListener("mousedown", (e) => {
        isDragging = true;
        startX = e.clientX - imageModalImg.offsetLeft;
        startY = e.clientY - imageModalImg.offsetTop;
      });

      imageModalImg.addEventListener("mouseup", () => (isDragging = false));
      imageModalImg.addEventListener("mouseleave", () => (isDragging = false));
      imageModalImg.addEventListener("mousemove", (e) => {
        if (isDragging) {
          e.preventDefault();
          imageModalImg.style.position = "relative";
          imageModalImg.style.left = `${e.clientX - startX}px`;
          imageModalImg.style.top = `${e.clientY - startY}px`;
        }
      });

      imageModalClose.addEventListener("click", () => {
        imageModal.style.display = "none";
        imageModalImg.src = "";
        resetImageModal();
      });

      imageModal.addEventListener("click", (e) => {
        if (e.target === imageModal) {
          imageModal.style.display = "none";
          imageModalImg.src = "";
          resetImageModal();
        }
      });

      // Detectar clics en imÃ¡genes del modal principal
      const modalImagen = document.getElementById("modalImagen");
      modalImagen.addEventListener("click", (e) => {
        if (e.target.tagName === "IMG") {
          imageModalImg.src = e.target.src;
          resetImageModal();
          imageModal.style.display = "flex";
        }
      });
    </script>
  </body>
</html>
