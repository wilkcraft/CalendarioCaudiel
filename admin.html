<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Calendario Caudiel</title>
    <link rel="icon" href="caudielLogo.png" />
    <style>
      body {
        font-family: "Arial", sans-serif;
        background: #fce4ec;
        padding: 20px;
        margin: 0;
        color: #5d5d5d;
      }

      header {
        position: relative;
        text-align: center;
        margin-bottom: 20px;
      }

      .logo-img {
        position: absolute;
        top: 10px;
        left: 10px;
        height: 80px;
        width: auto;
        pointer-events: none; /* hace que no se pueda clicar */
        user-select: none; /* evita que se seleccione */
      }

      h1 {
        text-align: center;
        color: #d81b60;
        font-size: 2.5em;
        margin-bottom: 20px;
      }

      .dia-semana {
        text-align: center;
        font-weight: bold;
        padding: 10px 0;
        border-bottom: 1px solid #f8bbd0;
        background-color: #ffe3ee;
      }

      .navegacion {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
      }

      .navegacion button {
        padding: 12px 24px;
        font-size: 1.2em;
        cursor: pointer;
        background-color: #ff80ab;
        color: white;
        border: none;
        border-radius: 12px;
        transition: background-color 0.3s;
        margin: 0 10px;
      }

      .navegacion button:hover {
        background-color: #f50057;
      }

      .calendario-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        width: 100%;
        margin-top: 20px;
      }

      .calendario {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        width: 90%;
        max-width: 1200px; /* Ajusta el ancho mÃ¡ximo */
        margin: 10px;
        background-color: #fff5f8;
        border: 2px solid #f8bbd0;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        box-sizing: border-box;
      }

      .calendario h2 {
        grid-column: span 7;
        text-align: center;
        margin: 0;
        font-size: 1.8em;
        font-weight: bold;
        color: #d81b60;
      }

      .calendario .dia {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        padding: 15px;
        height: 180px; /* ðŸ”¥ altura fija para todos los dÃ­as */
        border: 2px solid #f8bbd0;
        border-radius: 8px;
        background-color: #fff;
        cursor: pointer;
        overflow: hidden; /* evita que crezca mÃ¡s de la altura fija */
      }

      .numero {
        font-weight: bold;
        font-size: 1.5em;
        color: #d81b60;
        margin-bottom: 5px;
      }

      .nota {
        font-size: 1em;
        color: #555;
        text-align: center;
        max-height: 60px; /* ðŸ”¥ altura mÃ¡xima fija */
        overflow-y: auto; /* ðŸ”¥ scroll vertical si hay mucho texto */
        font-style: italic;
        width: 100%; /* se asegura de ocupar el ancho del dÃ­a */
        box-sizing: border-box;
        padding: 2px;
      }

      .nota.cargando {
        color: #555;
      }

      .popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #ffffff;
        padding: 20px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 15px;
        z-index: 10;
        display: none;
        max-width: 400px;
        width: 90%;
        box-sizing: border-box;
      }

      .popup h3 {
        margin-bottom: 10px;
        font-size: 1.5em;
        color: #d81b60;
        text-align: center;
      }

      .popup textarea {
        width: 100%;
        height: 100px;
        padding: 10px;
        font-size: 1em;
        border: 1px solid #f8bbd0;
        border-radius: 8px;
        resize: none;
      }

      .popup button {
        margin-top: 10px;
        padding: 12px;
        font-size: 1.2em;
        background-color: #d81b60;
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: background-color 0.3s;
        width: 100%;
      }

      .popup button:hover {
        background-color: #f50057;
      }

      #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.3);
        z-index: 5;
        display: none;
      }
      .navegacion {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
      }
      .navegacion button {
        padding: 12px 24px;
        font-size: 1.2em;
        cursor: pointer;
        background-color: #ff80ab;
        color: white;
        border: none;
        border-radius: 12px;
        transition: background-color 0.3s;
      }
      .navegacion button:hover {
        background-color: #f50057;
      }
      .navegacion select {
        padding: 10px;
        font-size: 1em;
        border-radius: 10px;
        border: 2px solid #f8bbd0;
        margin: 0 5px;
        background-color: white;
      }

      /* Ocultamos el input original */
      #input-imagen {
        display: none;
      }

      /* Estilizamos el botÃ³n personalizado */
      #btn-examinar {
        margin-top: 10px;
        display: inline-block;
        font-size: 1.2em;
        background-color: #d81b60;
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
        display: block; /* Necesario para que margin:auto funcione */
        width: 75%;
        margin: 10px auto 0 auto;
      }

      #btn-examinar:hover {
        background-color: #f50057;
      }

      .popup textarea,
      #input-imagen {
        box-sizing: border-box;
      }

      .imagenes-container {
        display: flex;
        overflow-x: auto;
        gap: 8px;
        max-width: 100%;
        max-height: 80px; /* ðŸ”¥ controla altura mÃ¡xima dentro del dÃ­a */
        padding: 5px 0;
        scroll-snap-type: x mandatory;
      }

      .imagenes-container img {
        height: 80px; /* ðŸ”¥ fija altura de cada imagen */
        width: auto;
        border-radius: 6px;
        flex-shrink: 0;
        scroll-snap-align: start;
      }

      .preview-imagenes {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
        max-height: 100px; /* ðŸ”¥ evita que crezca demasiado */
        overflow-y: auto; /* ðŸ”¥ scroll si hay muchas */
      }

      .preview-item {
        position: relative;
        display: inline-block;
      }

      .preview-item img {
        height: 70px;
        width: auto;
        border-radius: 8px;
        border: 1px solid #ccc;
      }

      .preview-item .eliminar-img {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 26px;
        height: 26px;
        border: none;
        cursor: pointer;
        border-radius: 30%;
        display: flex;
        align-items: center;
        justify-content: center; /* ðŸ”¥ centra el contenido */
        padding: 0;
      }

      .preview-item .eliminar-img img {
        width: 20px;
        height: 20px;
        pointer-events: none;
      }

      @media (max-width: 600px) {
        .calendario {
          display: flex !important;
          flex-direction: column;
        }

        .dia-semana {
          display: none; /* Ocultamos los encabezados de semana en mÃ³viles */
        }

        .calendario .dia {
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          gap: 5px;
          border: 1px solid #f8bbd0;
          padding: 10px;
          margin-bottom: 10px;
        }

        .calendario .dia .numero {
          font-size: 1.2em;
          margin-bottom: 0;
          margin-right: 10px;
        }

        .nota {
          text-align: left;
          flex-grow: 1;
        }

        .nombre-dia {
          font-weight: bold;
          color: #d81b60;
          font-size: 1.1em;
          display: none;
        }
        .dia-semana {
          display: none;
        }
        .calendario h2 {
          font-size: 1.5em;
          grid-column: span 1;
        }

        .dia img {
          max-width: 100%;
          margin-top: 8px;
          border-radius: 8px;
        }
        .logo-img {
          position: fixed;
          top: 5px;
          left: 5px;
          height: 70px;
          width: auto;
          pointer-events: none;
          user-select: none;
        }
        .resumen-semanal {
          display: flex;
          justify-content: space-between;
          background-color: #ffebf0;
          padding: 10px;
          margin-bottom: 10px;
          border: 2px solid #f8bbd0;
          border-radius: 10px;
          font-weight: bold;
          font-size: 0.9em;
          color: #d81b60;
        }
        .resumen-dia {
          flex: 1;
          text-align: center;
          cursor: pointer;
        }
        .resumen-dia .alerta {
          display: inline-block;
          margin-left: 5px;
          font-size: 2em;
          font-weight: bold;
          color: #ff0033;
          animation: parpadeo 1s infinite, rebote 1.5s infinite;
          text-shadow: 1px 1px 2px #fff, 0 0 5px #ff0033;
        }
        @keyframes parpadeo {
          0%,
          100% {
            opacity: 1;
          }
          50% {
            opacity: 0;
          }
        }
        @keyframes rebote {
          0%,
          100% {
            transform: translateY(0);
          }
          50% {
            transform: translateY(-3px);
          }
        }
      }
      .switch-wrapper {
        width: 100px;
        height: 40px;
        background-color: #fff;
        border-radius: 10px;
        margin: 15px auto 0;
        position: relative;
        cursor: pointer;
        border: 2px solid #ccc;
      }

      #switch-indicador {
        width: 28px;
        height: 28px;
        background-color: #d81b60;
        border-radius: 6px;
        position: absolute;
        top: 6px;
        left: 6px;
        transition: all 0.3s ease;
      }
      #input-imagen {
        color: #5d5d5d;
      }
    </style>
  </head>
  <body>
    <header>
      <img src="caudiel.png" alt="Caudiel Logo" class="logo-img" />
      <h1>Calendario Caudiel 2025-2026</h1>
      <div class="switch-wrapper" onclick="siguientePaleta()">
        <div id="switch-indicador"></div>
      </div>
    </header>

    <div class="navegacion">
      <button id="btn-anterior">Anterior</button>
      <button id="btn-siguiente">Siguiente</button>

      <select id="select-mes">
        <option value="0">Enero</option>
        <option value="1">Febrero</option>
        <option value="2">Marzo</option>
        <option value="3">Abril</option>
        <option value="4">Mayo</option>
        <option value="5">Junio</option>
        <option value="6">Julio</option>
        <option value="7">Agosto</option>
        <option value="8">Septiembre</option>
        <option value="9">Octubre</option>
        <option value="10">Noviembre</option>
        <option value="11">Diciembre</option>
      </select>

      <select id="select-anio"></select>
      <select id="select-semana" style="display: none"></select>
    </div>

    <div class="calendario-container" id="calendarios"></div>

    <!-- Overlay y Popup -->
    <div id="overlay"></div>
    <div class="popup" id="popup">
      <h3 id="titulo-dia">DÃ­a</h3>
      <textarea id="input-nota" placeholder="Escribe una nota..."></textarea>
      <button type="button" id="btn-examinar">Subir imagen...</button>
      <div id="preview-imagenes" class="preview-imagenes"></div>
      <button id="btn-guardar">Guardar</button>
      <button class="popupButton">Cerrar</button>
    </div>

    <script type="module">
      let imagenesSeleccionadas = [];

      if (sessionStorage.getItem("isLoggedIn") !== "true") {
        alert("Acceso no autorizado. SerÃ¡s redirigido al inicio.");
        window.location.href = "index.html";
      }

      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBp-39_WdV6uQ02mvMHu4ORLXFc96RTaOM",
        authDomain: "calendariocaudiel.firebaseapp.com",
        projectId: "calendariocaudiel",
        storageBucket: "calendariocaudiel.appspot.com",
        messagingSenderId: "780740498474",
        appId: "1:780740498474:web:d741fd88bc94f926685f53",
        measurementId: "G-PH31VFY827",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const calendarios = document.getElementById("calendarios");
      const popup = document.getElementById("popup");
      const overlay = document.getElementById("overlay");
      const inputNota = document.getElementById("input-nota");
      const tituloDia = document.getElementById("titulo-dia");
      const btnGuardar = document.getElementById("btn-guardar");

      const previewContainer = document.getElementById("preview-imagenes");
      const inputImagen = document.createElement("input");

      inputImagen.type = "file";
      inputImagen.accept = "image/*";
      inputImagen.multiple = true; // Permitir varias

      inputImagen.id = "input-imagen";
      inputImagen.style.marginTop = "10px";
      popup.insertBefore(inputImagen, previewContainer);

      function renderPreviewItem(src) {
        const item = document.createElement("div");
        item.className = "preview-item";

        const img = document.createElement("img");
        img.src = src;
        img.alt = "preview";

        const btnEliminar = document.createElement("button");
        btnEliminar.className = "eliminar-img";
        btnEliminar.innerHTML = `<img src="trash.png" alt="Eliminar">`;

        btnEliminar.addEventListener("click", () => {
          imagenesSeleccionadas = imagenesSeleccionadas.filter(
            (imagen) => imagen !== src
          );
          item.remove();
        });

        item.appendChild(img);
        item.appendChild(btnEliminar);
        previewContainer.appendChild(item);

        // ðŸ”¥ Aplica el color de la paleta actual
        const p = paletas[paletaActual];
        btnEliminar.style.backgroundColor = p.primario;
        btnEliminar.style.color = "white";
        btnEliminar.onmouseenter = () =>
          (btnEliminar.style.backgroundColor = p.primarioHover);
        btnEliminar.onmouseleave = () =>
          (btnEliminar.style.backgroundColor = p.primario);
      }

      // Cuando el usuario selecciona nuevas imÃ¡genes
      inputImagen.addEventListener("change", () => {
        Array.from(inputImagen.files).forEach((file) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const base64 = e.target.result;
            imagenesSeleccionadas.push(base64);
            renderPreviewItem(base64);
          };
          reader.readAsDataURL(file);
        });
        inputImagen.value = ""; // ðŸ”¥ limpia el input para no repetir
      });

      let diaSeleccionado = null;
      const today = new Date();
      let currentYear = today.getFullYear();
      let currentMonth = today.getMonth();
      const modoSemana = window.innerWidth <= 600;

      const selectMes = document.getElementById("select-mes");
      const selectAnio = document.getElementById("select-anio");
      const selectSemana = document.getElementById("select-semana");

      for (let y = 2024; y <= 2026; y++) {
        const option = document.createElement("option");
        option.value = y;
        option.textContent = y;
        selectAnio.appendChild(option);
      }
      let currentWeekStartDate = getStartOfWeek(new Date());
      let fechaSemanaActual = new Date(currentWeekStartDate); // sincronizado desde el inicio

      selectMes.value = currentMonth;
      selectAnio.value = currentYear;

      function esMovil() {
        return window.innerWidth <= 600;
      }

      const meses = [
        "Enero",
        "Febrero",
        "Marzo",
        "Abril",
        "Mayo",
        "Junio",
        "Julio",
        "Agosto",
        "Septiembre",
        "Octubre",
        "Noviembre",
        "Diciembre",
      ];

      function getStartOfWeek(date) {
        const copia = new Date(date); // Evita modificar el original
        const day = copia.getDay(); // Domingo: 0, Lunes: 1, ..., SÃ¡bado: 6
        const diff = day === 0 ? -6 : 1 - day; // Para que empiece el lunes
        copia.setDate(copia.getDate() + diff);
        copia.setHours(0, 0, 0, 0); // Reinicia hora por si acaso
        return copia;
      }

      function actualizarSemanas(year, month, seleccionarPrimera = false) {
        selectSemana.innerHTML = "";

        const primerDiaMes = new Date(year, month, 1);
        let primerLunes = getStartOfWeek(primerDiaMes);

        let semana = 1;
        let fecha = new Date(primerLunes);

        while (
          fecha.getMonth() === month ||
          (fecha < primerDiaMes && fecha.getMonth() === month - 1) ||
          (month === 0 && fecha.getMonth() === 11)
        ) {
          const opcion = document.createElement("option");
          opcion.value = fecha.toISOString();
          opcion.textContent = `Semana ${semana} (${fecha.getDate()} ${
            meses[fecha.getMonth()]
          })`;
          selectSemana.appendChild(opcion);
          semana++;
          fecha.setDate(fecha.getDate() + 7);
        }

        if (seleccionarPrimera && selectSemana.options.length > 0) {
          selectSemana.selectedIndex = 0;
          currentWeekStartDate = new Date(selectSemana.value);
        }
      }

      function seleccionarSemanaActual() {
        const opciones = Array.from(selectSemana.options);
        let mejorOpcion = 0;
        let menorDiferencia = Infinity;

        for (let i = 0; i < opciones.length; i++) {
          const fechaOpcion = new Date(opciones[i].value);
          const diferencia = Math.abs(fechaOpcion - currentWeekStartDate);
          if (diferencia < menorDiferencia) {
            menorDiferencia = diferencia;
            mejorOpcion = i;
          }
        }

        selectSemana.selectedIndex = mejorOpcion;
      }

      if (esMovil()) {
        selectSemana.style.display = "inline-block";

        // Obtener fecha de inicio de la semana actual real
        const hoy = new Date();
        currentWeekStartDate = getStartOfWeek(hoy);
        fechaSemanaActual = new Date(currentWeekStartDate);

        // Establecer el mes y aÃ±o segÃºn la semana actual
        currentYear = currentWeekStartDate.getFullYear();
        currentMonth = currentWeekStartDate.getMonth();
        selectMes.value = currentMonth;
        selectAnio.value = currentYear;

        // Actualiza el selector de semanas sin seleccionar automÃ¡ticamente la primera
        actualizarSemanas(currentYear, currentMonth, false);

        // Seleccionar en el <select> la semana que mÃ¡s se aproxime a la actual
        const opciones = Array.from(selectSemana.options);
        let mejorOpcion = 0;
        let menorDiferencia = Infinity;

        for (let i = 0; i < opciones.length; i++) {
          const fechaOpcion = new Date(opciones[i].value);
          const diferencia = Math.abs(fechaOpcion - currentWeekStartDate);
          if (diferencia < menorDiferencia) {
            menorDiferencia = diferencia;
            mejorOpcion = i;
          }
        }

        selectSemana.selectedIndex = mejorOpcion;
        currentWeekStartDate = new Date(selectSemana.value);
        fechaSemanaActual = new Date(currentWeekStartDate);

        // Evento para actualizar calendario al cambiar semana desde el select
        selectSemana.addEventListener("change", () => {
          const fechaSeleccionada = new Date(selectSemana.value);
          if (!isNaN(fechaSeleccionada)) {
            currentWeekStartDate = fechaSeleccionada;
            fechaSemanaActual = new Date(currentWeekStartDate);
            currentYear = currentWeekStartDate.getFullYear();
            currentMonth = currentWeekStartDate.getMonth();
            crearCalendario(currentYear, currentMonth);
          }
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        const btnExaminar = document.getElementById("btn-examinar");
        const inputImagen = document.getElementById("input-imagen");

        btnExaminar.addEventListener("click", () => {
          inputImagen.click(); // abre el selector de archivos
        });

        inputImagen.addEventListener("change", () => {
          console.log(inputImagen.files);
          // AquÃ­ puedes aÃ±adir tu cÃ³digo de previsualizaciÃ³n
        });
      });

      selectMes.addEventListener("change", () => {
        currentMonth = parseInt(selectMes.value);
        actualizarSemanas(currentYear, currentMonth, true);

        // Establece la fecha de la semana al inicio del mes
        if (selectSemana.options.length > 0) {
          selectSemana.selectedIndex = 0;
          fechaSemanaActual = new Date(selectSemana.value);
        }

        crearCalendario(currentYear, currentMonth);
      });

      selectAnio.addEventListener("change", () => {
        currentYear = parseInt(selectAnio.value);
        actualizarSemanas(currentYear, currentMonth, true);

        if (selectSemana.options.length > 0) {
          selectSemana.selectedIndex = 0;
          fechaSemanaActual = new Date(selectSemana.value);
        }

        crearCalendario(currentYear, currentMonth);
      });

      document.getElementById("btn-anterior").addEventListener("click", () => {
        if (esMovil()) {
          currentWeekStartDate.setDate(currentWeekStartDate.getDate() - 7);
          fechaSemanaActual = new Date(currentWeekStartDate);
          currentYear = currentWeekStartDate.getFullYear();
          currentMonth = currentWeekStartDate.getMonth();

          // Actualiza selects de mes y aÃ±o
          selectMes.value = currentMonth;
          selectAnio.value = currentYear;

          // Actualiza semanas y selecciona la actual
          actualizarSemanas(currentYear, currentMonth, false);
          seleccionarSemanaActual();
        } else {
          currentMonth = currentMonth === 0 ? 11 : currentMonth - 1;
          if (currentMonth === 11) currentYear--;
          selectMes.value = currentMonth;
          selectAnio.value = currentYear;
        }

        crearCalendario(currentYear, currentMonth);
      });

      document.getElementById("btn-siguiente").addEventListener("click", () => {
        if (esMovil()) {
          currentWeekStartDate.setDate(currentWeekStartDate.getDate() + 7);
          fechaSemanaActual = new Date(currentWeekStartDate);
          currentYear = currentWeekStartDate.getFullYear();
          currentMonth = currentWeekStartDate.getMonth();

          // Actualiza selects de mes y aÃ±o
          selectMes.value = currentMonth;
          selectAnio.value = currentYear;

          // Actualiza semanas y selecciona la actual
          actualizarSemanas(currentYear, currentMonth, false);
          seleccionarSemanaActual();
        } else {
          currentMonth = currentMonth === 11 ? 0 : currentMonth + 1;
          if (currentMonth === 0) currentYear++;
          selectMes.value = currentMonth;
          selectAnio.value = currentYear;
        }

        crearCalendario(currentYear, currentMonth);
      });

      if (modoSemana) {
        const dia = fechaSemanaActual.getDay();
        const offset = dia === 0 ? -6 : 1 - dia;
        fechaSemanaActual.setDate(fechaSemanaActual.getDate() + offset);
      }

      const diasSemana = ["Lun", "Mar", "MiÃ©", "Jue", "Vie", "SÃ¡b", "Dom"];

      async function abrirPopup(dia, mes, anio, notaElemento) {
        diaSeleccionado = dia;
        tituloDia.textContent = `DÃ­a ${dia} de ${meses[mes]} de ${anio}`;
        inputNota.value = notaElemento.textContent || "";
        overlay.style.display = "block";
        popup.style.display = "block";

        popup.dataset.dia = dia;
        popup.dataset.mes = mes;
        popup.dataset.anio = anio;

        imagenesSeleccionadas = []; // ðŸ”¥ solo al abrir, para evitar duplicados
        previewContainer.innerHTML = "";

        const nombreColeccion = `notas${anio}${parseInt(mes) + 1}`;
        const docRef = doc(db, nombreColeccion, String(dia));
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          const data = docSnap.data();

          // ðŸ”¥ cargar las imÃ¡genes que ya estaban en Firestore
          if (data.imagenesBase64 && Array.isArray(data.imagenesBase64)) {
            imagenesSeleccionadas = [...data.imagenesBase64]; // mantenemos todas
            imagenesSeleccionadas.forEach((src) => renderPreviewItem(src));
          } else if (data.imagenBase64) {
            imagenesSeleccionadas = [data.imagenBase64];
            renderPreviewItem(data.imagenBase64);
          }
        }
      }

      btnGuardar.addEventListener("click", async () => {
        const dia = popup.dataset.dia;
        const mes = popup.dataset.mes;
        const anio = popup.dataset.anio;
        const nota = inputNota.value;

        const nombreColeccion = `notas${anio}${parseInt(mes) + 1}`;
        const docRef = doc(db, nombreColeccion, dia);
        const data = { nota, imagenesBase64: imagenesSeleccionadas };

        await setDoc(docRef, data);
        cerrarPopupYActualizar(anio, mes);
      });

      function cerrarPopupYActualizar(anio, mes) {
        popup.style.display = "none";
        overlay.style.display = "none";
        crearCalendario(parseInt(anio), parseInt(mes));
      }

      async function crearCalendario(year, month) {
        // Limpiar el contenedor de calendarios para evitar duplicados
        calendarios.innerHTML = ""; // AsegÃºrate de eliminar el contenido viejo

        const diasEnMes = new Date(year, month + 1, 0).getDate();
        let primerDia = new Date(year, month, 1).getDay();
        primerDia = primerDia === 0 ? 6 : primerDia - 1;

        const calendario = document.createElement("div");
        calendario.classList.add("calendario");

        if (!modoSemana) {
          const titulo = document.createElement("h2");
          titulo.textContent = `${meses[month]} ${year}`;
          calendario.appendChild(titulo);

          diasSemana.forEach((d) => {
            const celda = document.createElement("div");
            celda.className = "dia-semana";
            celda.textContent = d;
            calendario.appendChild(celda);
          });

          for (let i = 0; i < primerDia; i++) {
            calendario.appendChild(document.createElement("div"));
          }
        }

        let diasParaMostrar = [];

        if (modoSemana) {
          const diasSemana = ["Lun", "Mar", "MiÃ©", "Jue", "Vie", "SÃ¡b", "Dom"];

          // TÃ­tulo del mes
          const titulo = document.createElement("h2");
          titulo.textContent = `${
            meses[fechaSemanaActual.getMonth()]
          } ${fechaSemanaActual.getFullYear()}`;
          calendario.appendChild(titulo);

          // Bloque resumen semanal
          const resumen = document.createElement("div");
          resumen.className = "resumen-semanal";
          const resumenHandlers = [];
          for (let i = 0; i < 7; i++) {
            const label = document.createElement("div");
            label.className = "resumen-dia";
            label.textContent = diasSemana[i];
            resumen.appendChild(label);
            resumenHandlers.push(label);
          }
          calendario.appendChild(resumen);

          // Luego tu bucle que crea cada dÃ­a de la semanaâ€¦
          for (let i = 0; i < 7; i++) {
            const date = new Date(fechaSemanaActual);
            date.setDate(fechaSemanaActual.getDate() + i);
            const dia = date.getDate();
            const mes = date.getMonth();
            const aÃ±o = date.getFullYear();

            const celda = document.createElement("div");
            celda.className = "dia";
            celda.dataset.dia = dia;

            const numero = document.createElement("div");
            numero.className = "numero";
            numero.textContent = dia;

            const nota = document.createElement("div");
            nota.className = "nota cargando";
            nota.textContent = "Cargando...";

            celda.appendChild(numero);
            celda.appendChild(nota);
            calendario.appendChild(celda);

            celda.addEventListener("click", () =>
              abrirPopup(dia, mes, aÃ±o, nota)
            );

            try {
              const nombreColeccion = `notas${aÃ±o}${mes + 1}`;
              const docRef = doc(db, nombreColeccion, String(dia));
              const docSnap = await getDoc(docRef);
              if (docSnap.exists()) {
                const data = docSnap.data();
                nota.textContent = data.nota || "";
                if (data.imagenesBase64 && Array.isArray(data.imagenesBase64)) {
                  const contenedor = document.createElement("div");
                  contenedor.className = "imagenes-container";

                  data.imagenesBase64.forEach((src) => {
                    const img = document.createElement("img");
                    img.src = src;
                    img.alt = "Imagen del dÃ­a";
                    contenedor.appendChild(img);
                  });

                  celda.appendChild(contenedor);
                } else if (data.imagenBase64) {
                  const contenedor = document.createElement("div");
                  contenedor.className = "imagenes-container";

                  const img = document.createElement("img");
                  img.src = data.imagenBase64;
                  img.alt = "Imagen del dÃ­a";
                  contenedor.appendChild(img);

                  celda.appendChild(contenedor);
                }

                if (
                  (data.nota && data.nota.trim() !== "") ||
                  data.imagenBase64 ||
                  (data.imagenesBase64 && data.imagenesBase64.length > 0)
                ) {
                  const alerta = document.createElement("span");
                  alerta.textContent = "!";
                  alerta.className = "alerta";
                  resumenHandlers[i].appendChild(alerta);
                  resumenHandlers[i].addEventListener("click", () => {
                    abrirPopup(dia, mes, aÃ±o, nota);
                  });
                }
              } else {
                nota.textContent = "";
              }
            } catch (e) {
              nota.textContent = "[Error]";
              console.error(e);
            }
          }
        } else {
          for (let dia = 1; dia <= diasEnMes; dia++) {
            diasParaMostrar.push({
              dia,
              mes: month,
              aÃ±o: year,
              date: new Date(year, month, dia),
            });
          }
        }

        // Recorrer todos los dÃ­as para crear las celdas
        for (const { date, dia, mes, aÃ±o } of diasParaMostrar) {
          const celda = document.createElement("div");
          celda.className = "dia";
          celda.dataset.dia = dia;

          if (modoSemana) {
            const nombreDia = document.createElement("div");
            nombreDia.className = "nombre-dia";
            nombreDia.textContent =
              diasSemana[date.getDay() === 0 ? 6 : date.getDay() - 1];
            celda.appendChild(nombreDia);
          }

          const numero = document.createElement("div");
          numero.className = "numero";
          numero.textContent = dia;

          const nota = document.createElement("div");
          nota.className = "nota cargando";
          nota.textContent = "Cargando...";

          celda.appendChild(numero);
          celda.appendChild(nota);

          celda.addEventListener("click", () =>
            abrirPopup(dia, mes, aÃ±o, nota)
          );
          calendario.appendChild(celda);

          try {
            const nombreColeccion = `notas${aÃ±o}${mes + 1}`;
            const docRef = doc(db, nombreColeccion, String(dia));
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
              const data = docSnap.data();
              nota.textContent = data.nota || "";

              if (data.imagenesBase64 && Array.isArray(data.imagenesBase64)) {
                const contenedor = document.createElement("div");
                contenedor.className = "imagenes-container";

                data.imagenesBase64.forEach((src) => {
                  const img = document.createElement("img");
                  img.src = src;
                  img.alt = "Imagen del dÃ­a";
                  contenedor.appendChild(img);
                });

                celda.appendChild(contenedor);
              } else if (data.imagenBase64) {
                const contenedor = document.createElement("div");
                contenedor.className = "imagenes-container";

                const img = document.createElement("img");
                img.src = data.imagenBase64;
                img.alt = "Imagen del dÃ­a";
                contenedor.appendChild(img);

                celda.appendChild(contenedor);
              }
            } else {
              nota.textContent = "";
            }
          } catch (error) {
            nota.textContent = "[Error]";
            console.error(error);
          }
        }

        // AÃ±adir el calendario generado al contenedor
        calendarios.appendChild(calendario);
        cambiarPaleta(paletaActual);
      }

      crearCalendario(currentYear, currentMonth);

      // Cerrar popup al hacer clic en el botÃ³n "Cerrar"
      document.querySelector(".popupButton").addEventListener("click", () => {
        popup.style.display = "none";
        overlay.style.display = "none";
      });

      // Cerrar popup al hacer clic fuera de Ã©l
      overlay.addEventListener("click", () => {
        popup.style.display = "none";
        overlay.style.display = "none";
      });

      // Evitar que al hacer clic dentro del popup se cierre
      popup.addEventListener("click", (e) => {
        e.stopPropagation();
      });
    </script>
    <script>
      let paletaActual = 0;
      const paletas = [
        {
          fondo: "#fce4ec",
          texto: "#5d5d5d",
          primario: "#d81b60",
          primarioHover: "#f50057",
          secundario: "#ffe3ee",
          borde: "#f8bbd0",
          fondoSemanal: "#ffebf0",
        },
        {
          fondo: "#e8f5e9",
          texto: "#2e7d32",
          primario: "#388e3c",
          primarioHover: "#43a047",
          secundario: "#d0f0d0",
          borde: "#a5d6a7",
          fondoSemanal: "#e0f7e9",
        },
        {
          fondo: "#e6f2ff",
          texto: "#003366",
          primario: "#005bb5",
          primarioHover: "#007acc",
          secundario: "#cce6ff",
          borde: "#99ccff",
          fondoSemanal: "#d9ecff",
        },
      ];

      function siguientePaleta() {
        paletaActual = (paletaActual + 1) % paletas.length;
        cambiarPaleta(paletaActual);
      }

      function cambiarPaleta(index) {
        paletaActual = index;
        const p = paletas[index];

        // Estilos generales
        document.body.style.background = p.fondo;
        document.body.style.color = p.texto;

        document
          .querySelectorAll("h1, .numero, .resumen-semanal, .calendario h2")
          .forEach((el) => {
            el.style.color = p.primario;
          });

        document
          .querySelectorAll(
            ".login-btn, .navegacion button, .login-form button, .close"
          )
          .forEach((el) => {
            el.style.backgroundColor = p.primario;
            el.style.color = "white";
          });

        // BotÃ³n de eliminar imagen (trash)
        document.querySelectorAll(".eliminar-img").forEach((btn) => {
          btn.style.backgroundColor = p.primario;
          btn.style.color = "white";

          // Hover dinÃ¡mico
          btn.onmouseenter = () =>
            (btn.style.backgroundColor = p.primarioHover);
          btn.onmouseleave = () => (btn.style.backgroundColor = p.primario);
        });

        document
          .querySelectorAll(".calendario, .dia, .login-form, .resumen-semanal")
          .forEach((el) => {
            el.style.borderColor = p.borde;
          });

        document.querySelectorAll(".dia-semana").forEach((el) => {
          el.style.backgroundColor = p.secundario;
          el.style.borderBottomColor = p.borde;
        });

        document.querySelectorAll(".calendario").forEach((el) => {
          el.style.backgroundColor = p.secundario;
        });

        document.querySelectorAll("select").forEach((el) => {
          el.style.borderColor = p.borde;
          el.style.color = p.texto;
        });

        // Mover y recolorear el cuadrado del switch
        const indicador = document.getElementById("switch-indicador");
        const posiciones = ["6px", "calc(50% - 14px)", "calc(100% - 34px)"];
        indicador.style.left = posiciones[index];
        indicador.style.backgroundColor = p.primario;
        document.querySelector(".switch-wrapper").style.borderColor = p.borde;

        // Popup general
        const popup = document.getElementById("popup");
        popup.style.backgroundColor = "#fff"; // o puedes usar p.fondo si lo prefieres
        popup.style.borderColor = p.borde;
        popup.style.color = p.texto;

        // TÃ­tulo del popup
        document.querySelector("#popup h3").style.color = p.primario;

        // Textarea
        document.querySelector("#popup textarea").style.borderColor = p.borde;
        document.querySelector("#popup textarea").style.backgroundColor =
          "#fff0f5"; // puedes usar otro color claro
        document.querySelector("#popup textarea").style.color = p.texto;

        // Botones del popup
        document.querySelectorAll("#popup button").forEach((btn) => {
          btn.style.backgroundColor = p.primario;
          btn.style.color = "white";

          btn.onmouseenter = () =>
            (btn.style.backgroundColor = p.primarioHover);
          btn.onmouseleave = () => (btn.style.backgroundColor = p.primario);
        });

        // Input de imagen
        const inputImg = document.getElementById("input-imagen");
        if (inputImg) {
          inputImg.style.borderColor = p.borde;
          inputImg.style.backgroundColor = "#fff0f5";
        }

        // FunciÃ³n para oscurecer el color
        function oscurecerColor(hex, porcentaje) {
          const num = parseInt(hex.replace("#", ""), 16);
          let r = (num >> 16) - porcentaje;
          let g = ((num >> 8) & 0x00ff) - porcentaje;
          let b = (num & 0x0000ff) - porcentaje;

          r = Math.max(0, r);
          g = Math.max(0, g);
          b = Math.max(0, b);

          return `rgb(${r}, ${g}, ${b})`;
        }

        // BotÃ³n eliminar imagen
        const btnEliminar = document.getElementById("btn-eliminar-imagen");
        if (btnEliminar) {
          const colorOscuro = oscurecerColor(p.primario, 40); // puedes probar con 30 o 50
          btnEliminar.style.backgroundColor = colorOscuro;
          btnEliminar.style.color = "white";
        }

        document
          .querySelectorAll(
            ".login-btn, .navegacion button, .login-form button, .close"
          )
          .forEach((el) => {
            el.style.backgroundColor = p.primario;
            el.style.color = "white";

            // Hover dinÃ¡mico
            el.onmouseenter = () =>
              (el.style.backgroundColor = p.primarioHover);
            el.onmouseleave = () => (el.style.backgroundColor = p.primario);
          });

        document.querySelectorAll(".resumen-semanal").forEach((el) => {
          el.style.backgroundColor = p.fondoSemanal;
        });

        // Cambiar color del signo "!" segÃºn paleta
        const colorAlertas = ["#ff0033", "#2e7d32", "#005bb5"];
        document.querySelectorAll(".alerta").forEach((el) => {
          el.style.color = colorAlertas[index];
          el.style.textShadow = `1px 1px 2px #fff, 0 0 5px ${colorAlertas[index]}`;
        });
      }

      // Inicializar paleta al cargar
      window.addEventListener("DOMContentLoaded", () => cambiarPaleta(0));
    </script>
  </body>
</html>
